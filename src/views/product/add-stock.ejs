<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambah Stok</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include("../partials/navbar.ejs") -%>
    <div class="container my-5">
        <h1 class="mb-3">Tambah Stok</h1>
        <form method="put">
            <div class="row mb-3">
                <div class="col-12 col-md-3">Kode produk</div>
                <div class="col-9">
                    <span class="d-none d-md-inline-block">:</span>
                    <span id="code"></span>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-12 col-md-3">Nama produk</div>
                <div class="col-9">
                    <span class="d-none d-md-inline-block">:</span>
                    <span id="name"></span>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-12 col-md-3">Lokasi penyimpanan</div>
                <div class="col-9">
                    <span class="d-none d-md-inline-block">:</span>
                    <span id="storage-type"></span>
                </div>
            </div>
            <div class="form-group row">
                <label for="addition-stock" class="col-12 col-md-3 col-form-label">Stok yang ditambahkan</label>
                <div class="col-9">
                    <input class="form-control input-stock" type="text" name="addition-stock" id="addition-stock" placeholder="Contoh: 100" data-numberonly="true" onkeyup="handleAdditionQtyChange(this)">
                    <small>Jumlah stok yang ditambahkan mengikuti satuan terbesar</small>
                    <div class="invalid-feedback" id="addition-stock-error"></div>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-12 col-md-3 mb-3 mb-md-0">Varian</div>
                <div class="col-12 col-md-9" id="variant"></div>
            </div>            
            <a href="/product" class="btn btn-secondary">Kembali</a>
            <button class="btn btn-success ml-2">Simpan perubahan</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script>
    <script src="/js/helper.js"></script>
    <script>
        let data = {};

        $("document").ready(function() {
            fetchData("<%=id%>");
            initSave();
            initAllowNumberOnly();
        });

        function fetchData(id) {
            $.ajax({
                method: "get",
                url: "/api/product/" + id,
                contentType: "application/json",
                success: function(result) {
                    data = result.data;
                    $("#code").text(data.code);
                    $("#name").text(data.name);
                    $("#storage-type").text(data.storageType);

                    renderProductVariant(data)

                }, error: function(error) {
                    console.log(error);
                }
            });
        }

        function renderProductVariant(data) {
            const el = $("#variant");
            el.html("");
            data.productVariant.forEach((productVariant, index) => {
                if (!productVariant.deletedAt) {
                    el.append(
                        '<div class="border rounded p-3 w-100 mb-3">' +
                            '<div class="mb-3 font-weight-bold">Variant ke-'+(index + 1)+'</div>' +
                            '<div class="row mb-3">' +
                                '<div class="col-md-5">Satuan</div>' +
                                '<div class="col-md-7"><span class="d-none d-md-inline-block">:</span> ' + productVariant.unit + '</div>' +
                            '</div>' +
                            '<div class="row mb-3">' +
                                '<div class="col-md-5">Harga</div>' +
                                '<div class="col-md-7"><span class="d-none d-md-inline-block">:</span> ' + (rupiahFormat(productVariant.price)) + '</div>' +
                            '</div>' +
                            '<div class="row">' +
                                '<div class="col-md-5">Stok lama</div>' +
                                '<div class="col-md-7"><span class="d-none d-md-inline-block">:</span> ' + (productVariant.child ? Math.floor(data.qty / productVariant.qtyPerUnit) : data.qty) + ' ' + productVariant.unit + '</div>' +
                            '</div>' +
                            '<div class="row mt-3 text-success">' +
                                '<div class="col-md-5">Stok baru</div>' +
                                '<div class="col-md-7"><span class="d-none d-md-inline-block">:</span> <span id="new-stock-'+index+'">' + (productVariant.child ? Math.floor(data.qty / productVariant.qtyPerUnit) : data.qty) + ' ' + productVariant.unit + '</span></div>' +
                            '</div>' +
                        '</div>'
                    );
                }
            });
        }

        function handleAdditionQtyChange(e) {
            const el = $(e);
            const value = +el.val();
            calculateNewStock(value);
        }

        // Calculate new stock
        // Formula: if productVariant have child, newQty = oldQty + additionQty. 
        // Else, newQty = oldQty + Math.floor(additionQty / qtyPerUnit)
        function calculateNewStock(additionQty) {
            let qtyPerUnits = data.productVariant.map((item) => item.qtyPerUnit);
            qtyPerUnits.forEach((item) => {
                additionQty = additionQty * item
            });

            const oldQty = data.qty;
            const currentQuantity = oldQty + additionQty;

            let realQuantityPerUnits = [];

            for (let i = 0; i < qtyPerUnits.length; i++) {
                let temp = qtyPerUnits[i];

                for (let j = i + 1; j < qtyPerUnits.length; j++) {
                    temp = temp * qtyPerUnits[j];
                }

                realQuantityPerUnits.push(temp);
            }

            console.log("currentQuantity: ", currentQuantity);
            for (let i = 0; i < data.productVariant.length; i++) {
                const newQty = Math.floor(currentQuantity / realQuantityPerUnits[i]);
                $("#new-stock-"+i).text(newQty + " " + data.productVariant[i].unit);
            }
        }

        function initSave() {
            $("form").submit(function(e) {
                e.preventDefault();
                $.ajax({
                    url: "/api/product/update-stock/<%=id%>",
                    method: "put",
                    data: {
                        additionQty: additionQty
                    },
                    success: function(result) {
                        alert("Stock berhasil ditambahkan.");
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
            });
        }
    </script>
</body>
</html>